---
layout: post
title:  "ICFPC 2018: 3D printing"
---

<img src="img/icfpc-2018/logo.png" style="width: 75%;"/>

[This year](https://icfpcontest2018.github.io/full/task-description.html) ICFPC
was about finding optimal solution to 3D printing problem.


## **Overall impression**

* Contest was really well organized. Everything went smoothly and without hiccups.
* There was leaderboard! It's a big deal and helped to strive for being competitive.
* The problem was quite visual and easy to understand.
* On the other hand, I think that the problem wasn't really deep enough
(compared to "Lambda the gathering" or "Cars and Fuel" years).
* Initially I thought the problem space is quite narrow, but after lightning round there was
enough parallelization between team members to work on different tasks.
* The problem ended up being computationally expensive, so I am glad we used C++ and not python.

## **Results**


We finished on 3rd place in frozen results. Here is top16 of teams:
<img src="img/icfpc-2018/frozen-top.png" style="width: 100%;"/>




<!-- // for table with results below -->
<!-- <link rel="stylesheet" href="/img/icfpc-2018/table.css">
<table>
  <thead>
    <tr>
      <th style="width:55px">Rank</th>
      <th style="width:330px">Team</th>
      <th style="width:220px">Total Energy</th>
      <th style="width:110px">Total Score</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align:right"><pre>1</pre></td>
      <td style="text-align:left"><pre>Unagi</pre></td>
      <td style="text-align:right"><pre>10055602187474</pre></td>
      <td style="text-align:right"><pre>2669786</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>2</pre></td>
      <td style="text-align:left"><pre>shinh</pre></td>
      <td style="text-align:right"><pre>97589584859259</pre></td>
      <td style="text-align:right"><pre>2666756</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>3</pre></td>
      <td style="text-align:left"><pre>Lambding Snakes vs. Coding Monkeys</pre></td>
      <td style="text-align:right"><pre>217410985815872</pre></td>
      <td style="text-align:right"><pre>2659855</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>4</pre></td>
      <td style="text-align:left"><pre>Frictionless Bananas</pre></td>
      <td style="text-align:right"><pre>202431348058445</pre></td>
      <td style="text-align:right"><pre>2657313</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>5</pre></td>
      <td style="text-align:left"><pre>kontur.ru</pre></td>
      <td style="text-align:right"><pre>320973374383974</pre></td>
      <td style="text-align:right"><pre>2657005</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>6</pre></td>
      <td style="text-align:left"><pre>Play Race for the Galaxy on your...</pre></td>
      <td style="text-align:right"><pre>245239428695346</pre></td>
      <td style="text-align:right"><pre>2655413</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>7</pre></td>
      <td style="text-align:left"><pre>perpetuum mobile</pre></td>
      <td style="text-align:right"><pre>11527158128679544</pre></td>
      <td style="text-align:right"><pre>2648158</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>8</pre></td>
      <td style="text-align:left"><pre>CowDay</pre></td>
      <td style="text-align:right"><pre>1154612030764759</pre></td>
      <td style="text-align:right"><pre>2647295</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>9</pre></td>
      <td style="text-align:left"><pre>The Blind Hen</pre></td>
      <td style="text-align:right"><pre>7145622481554496</pre></td>
      <td style="text-align:right"><pre>2646181</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>10</pre></td>
      <td style="text-align:left"><pre>code-o-matic</pre></td>
      <td style="text-align:right"><pre>171404488047700</pre></td>
      <td style="text-align:right"><pre>2644954</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>11</pre></td>
      <td style="text-align:left"><pre>301</pre></td>
      <td style="text-align:right"><pre>747996656957118</pre></td>
      <td style="text-align:right"><pre>2636552</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>12</pre></td>
      <td style="text-align:left"><pre>銀閣寺GOLD</pre></td>
      <td style="text-align:right"><pre>1029084651567466</pre></td>
      <td style="text-align:right"><pre>2635628</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>13</pre></td>
      <td style="text-align:left"><pre>yowa</pre></td>
      <td style="text-align:right"><pre>521667955357765</pre></td>
      <td style="text-align:right"><pre>2621245</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>14</pre></td>
      <td style="text-align:left"><pre>Vanilla Bears (kontur.ru)</pre></td>
      <td style="text-align:right"><pre>595824039294176</pre></td>
      <td style="text-align:right"><pre>2620294</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>15</pre></td>
      <td style="text-align:left"><pre>sanma</pre></td>
      <td style="text-align:right"><pre>1005799267594771</pre></td>
      <td style="text-align:right"><pre>2617196</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>16</pre></td>
      <td style="text-align:left"><pre>Piggybank Software</pre></td>
      <td style="text-align:right"><pre>480552164359295</pre></td>
      <td style="text-align:right"><pre>2616076</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>17</pre></td>
      <td style="text-align:left"><pre>Skobochka</pre></td>
      <td style="text-align:right"><pre>826580797619276</pre></td>
      <td style="text-align:right"><pre>2614863</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>18</pre></td>
      <td style="text-align:left"><pre>negainoido</pre></td>
      <td style="text-align:right"><pre>2160501629122671</pre></td>
      <td style="text-align:right"><pre>2613132</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>19</pre></td>
      <td style="text-align:left"><pre>uni</pre></td>
      <td style="text-align:right"><pre>985528456648629</pre></td>
      <td style="text-align:right"><pre>2600142</pre></td>
    </tr>
    <tr>
      <td style="text-align:right"><pre>20</pre></td>
      <td style="text-align:left"><pre>Team Sampou</pre></td>
      <td style="text-align:right"><pre>1240104660616154</pre></td>
      <td style="text-align:right"><pre>2583003</pre></td>
    </tr>
  </tbody>
</table> -->

**UPDATE**.
In final results we were only on 51st place as several of our solutions had a bug that wasn't caught
by our checker and we thought they are legit.

<img src="img/icfpc-2018/top-50.png" style="width: 100%;"/>


**UPDATE2**.
After fixing the bug and recalculating score we have `2664144` scores which would get us to 8th place. Oh, wow.

<img src="img/icfpc-2018/top-15.jpg" style="width: 90%;"/>


## **Lightning round**
**UPDATE**.
In lightning round we finished on 7th place.

<img src="img/icfpc-2018/lightning.png" style="width: 100%;"/>


Usually we skip lightning round and focus solving the main problem. But this time organizers
initially published only lightning round task description, so we had to solve that. There still
was a chance that main round would be completely different, but that sounded unlikely and
in any case every other team would be in the same boat too.


On a high-level the problem this time was quite simple.
You are given image for 3D printer and you need to write a program for bots to create it with
minimal cost (spent energy). You were allowed to switch between high and low harmonics mode,
which basically meant enabling/disabling levitation mode.
This levitation was actually quite interesting, as unlike regular 3D printing
it allowed you to create parts of the figure that would be flying in the air.
The final result have to be grounded.

Here is the list of available commands:

  * do nothing (`Wait`)
  * move (`SMove`, `LMove`)
  * switch low/high harmonics (`Flip`)
  * create pixel (`Fill`)
  * spawn new bot (`Fission`)
  * merge 2 bots (`Fusion`)


There was energy cost associated with each command.

The first key observation was that
in addition to command cost, every game tick you spend enormous amount of energy: `3 * R^3` or
`30 * R^3` for high harmonics. This is order of magnitude larger than what commands cost themselves.
So really the main goal is to build the image in smallest number of steps.

This means that we should always build with as many robots as possible.
Having extra bots on the field is super cheap, but they can reduce the total number of steps
potentially by 20x.

### Solution

Initially we were thinking about writing in python, but our other half of the team who were sitting
in Irvine started leading the effort on C++, so we sticked to that.

What we did as a solution for lightning round:

* Always use levitation mode
(except the few problems where all layers are always grounded on previous one)
* Build figure layer by layer
* Split the bots into 20 ones (or smaller if the size is small) and each works on its own split of
XZ plane. This way it is guaranteed they won't interfere with each other.
* Once the layer is done, all bots go up one layer and continue process
* On top of this have a solver that within certain timeout (`10 min`) tries different splits
(by both X and Z axis) and returns the best found result
* Small optimization to disable final `Flip` after we did last `Fill`


### Things that didn't work out
* We implemented a visualizer in jupyter notebook, but it wasn't really useful as we ended up using python.
Here is screenshot how the things look
<img src="img/icfpc-2018/visual.png" style="width: 75%;"/>
* We tried to do BFS-like filling in order to not use levitation for layer-grounded figures
(which means each layer is grounded when built on top of previous layer, for example, this is not layer-grounded figure:

<img src="img/icfpc-2018/layers.png" style="width: 50%;"/>

But this ends up being too complicated to implement with multiple bots working simultaneously.


## **Main round**

Once the lightning round was finished they released the description for main round.
The main differences were the following:

* `Void` command to erase the pixel
* `GFill` and `GVoid` commands to erase group of pixels in one step.
`2^n` bots should specify the corners of n-dimensional simplex.
* Maximum number of bots increased to 40.
* New set of problems:
  * `Disassmble` - from a given figure get the empty field
  * `Reassemble` - from a figure A get the figure B.


### Solution

* On the high level we have multiple solvers that were running for each type of problem and choosing
the best result
* We implemented autoharmonics - postprocessing step which turns on/off harmonics if it's possible.
Even if we would do it only for 2 steps it would still be beneficial.
* We have multiple layers of protection when saving results to make sure we never overwrite
with worse solution

### Assembly problems

`SolverNonGravitated` and `SolverGravitated`

We call object grounded if it's possible to construct it without high harmonics switched on.
The property can be easily checked with BFS.

We run BFS to split whole object by the distance from the floor (one can via faces of the voxels).

Further action is a sheer prescripted work. We construct the object layer by layer.

1. We fission bots into 20 or less if the size is small.
2. These bots can decouple each other and cover one-dimension straps on the current level with `GFill`.
3. Than all bots lift-up on one level and repeat construction.
4. At the end, we merge them together, and than put a single bot to the origin.


### Disassembly problems

`Solver2D_Demolition`

* Split the bounding box of figure into long strip of width 29.
* And then use it as sliding window to swipe the whole Layer.
* Continue until reaching ground.
* We often used inversing of commands for code simplicity
(e.g. after we spawned the bots on the gird, we can do inverse command in reversed order to despawn them back)

`SolverCubeDemolition`

* This only works on problems less than `30x30x30` dimensions of bounding box.
* It forks bots and puts into corners of the cube.
* Then does one `GVoid` to wipe it
* Doesn't even flip the harmonics

`Solver2D_Demolition_Tuned` and `SolverCubeDemolition_Tuned`

* Obviously, finely tuned versions to improve energy usage
* Fissions and fusions are manually aligned to axis to save energy
* Bounding box is `(0, 0, 0)`-based when possible to save time on movement
* Empty slices are ignored


### Reassembly problems

* The main solution we used here was to just use best of Assembly + Disassembly from all of the above solvers.
* We tried using greedy incremental reassembler (only change the xor of figures), but this idea
didn't pan out


### Command line tools

* To run the solution on all problems:

```
cd src/cpp/
make && ./build/cpp_solver
```

* For specific problem one can use

```
./build/cpp_solver -test A042
```

* The parameter `test` also supports a regexp:

```
./build/cpp_solver -test "D\d\d\d"
```

* All the algorithms live in corresponding folders:

```
src/cpp/solver_assembly/
src/cpp/solver_disassembly/
src/cpp/solver_reassembly/
```

* The solver can use multiple threads for processing (`-threads #`).
* Solutions organization:
  * The solver output solutions to `cppTracesF`.
  * We join the current best solutions with candidates using `-mode merge` mode and write into `submitTraces`
  * We also can use `-mode check -levitation 0` for validation of current solutions.
